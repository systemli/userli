{% set route = app.request.attributes.get('_route') %}
{% set route_params = app.request.attributes.get('_route_params') %}
{% set params = route_params|merge(app.request.query.all) %}

{% set locale_names = {
    'en': 'English',
    'de': 'Deutsch',
    'fr': 'Français',
    'es': 'Español',
   'it': 'Italiano',
   'pt': 'Português',
   'nb': 'Norsk',
   'gsw': 'Alemannisch',
   'zh_Hant': '繁體中文'
} %}

{% if dropdown_mode is defined and dropdown_mode %}
    {# Language switcher for user dropdown context #}
    <div class="space-y-1">
        {% for locale in locales %}
            <a
                href="{{ path(route, params|merge({ _locale: locale })) }}"
                class="flex items-center px-2 py-1.5 text-sm rounded-xl transition-all duration-200 {{ locale == app.request.locale ? 'bg-blue-50 dark:bg-blue-900/50 text-blue-700 dark:text-blue-300 font-medium' : 'text-gray-600 dark:text-gray-300 hover:bg-gray-50 dark:hover:bg-gray-700 hover:text-gray-900 dark:hover:text-gray-200' }}"
            >
                <span class="flex-shrink-0 w-5 h-5 mr-2 rounded-full {{ locale == app.request.locale ? 'bg-blue-100 dark:bg-blue-800 text-blue-600 dark:text-blue-300' : 'bg-gray-200 dark:bg-gray-600 text-gray-600 dark:text-gray-300' }} flex items-center justify-center text-xs font-medium transition-colors duration-200">
                    {{ locale|upper }}
                </span>
                <span class="text-xs">{{ locale_names[locale] ?? locale|upper }}</span>
                {% if locale == app.request.locale %}
                    {{ ux_icon('heroicons:check', {class: 'w-3 h-3 ml-auto text-blue-600 dark:text-blue-400'}) }}
                {% endif %}
            </a>
        {% endfor %}
    </div>
{% else %}
    {# Modern language switcher for main navigation #}
    <div class="relative inline-block text-left" data-controller="dropdown">
        <div>
            <button
                type="button"
                class="inline-flex items-center justify-center px-2 lg:px-3 py-2 text-sm font-medium text-white hover:text-gray-300 focus:outline-none focus:ring-2 focus:ring-white/50 rounded-2xl transition-all duration-300 hover:bg-white/10 hover:scale-105"
                data-dropdown-target="button"
                data-action="dropdown#toggle"
                aria-expanded="false"
                aria-haspopup="true"
                title="{{ 'navbar.language'|trans }}"
            >
                {{ ux_icon('heroicons:language', {class: 'w-4 h-4 lg:mr-1 xl:mr-2'}) }}
                <span class="sr-only">{{ 'navbar.language'|trans }}:</span>
                <span class="hidden lg:inline xl:inline">{{ app.request.locale|upper }}</span>
                {{ ux_icon('heroicons:chevron-down', {class: 'w-3 h-3 lg:ml-1 transition-transform duration-200', 'data-dropdown-target': 'arrow'}) }}
            </button>
        </div>

        {# Dropdown menu #}
        <div
            data-dropdown-target="menu"
            class="absolute right-0 z-50 mt-3 w-48 origin-top-right bg-white dark:bg-gray-800 rounded-3xl shadow-2xl ring-1 ring-black/10 dark:ring-white/10 divide-y divide-gray-100 dark:divide-gray-700 focus:outline-none opacity-0 scale-95 pointer-events-none transition-all duration-300"
            role="menu"
            aria-orientation="vertical"
        >
            <div class="py-2" role="none">
                {% for locale in locales %}
                    <a
                        href="{{ path(route, params|merge({ _locale: locale })) }}"
                        class="group flex items-center px-4 py-3 text-sm transition-all duration-300 rounded-2xl mx-2 {{ locale == app.request.locale ? 'bg-gray-100 dark:bg-gray-700 text-gray-900 dark:text-gray-100 font-medium' : 'text-gray-700 dark:text-gray-300 hover:bg-gray-50 dark:hover:bg-gray-700 hover:text-gray-900 dark:hover:text-gray-100' }}"
                        role="menuitem"
                    >
                        <span class="flex-shrink-0 w-6 h-6 mr-3 rounded-full {{ locale == app.request.locale ? 'bg-blue-100 dark:bg-blue-800 text-blue-600 dark:text-blue-300' : 'bg-gray-200 dark:bg-gray-600 text-gray-600 dark:text-gray-300 group-hover:bg-gray-300 dark:group-hover:bg-gray-500' }} flex items-center justify-center text-xs font-medium transition-colors duration-300">
                            {{ locale|upper }}
                        </span>
                        {{ locale_names[locale] ?? locale|upper }}
                        {% if locale == app.request.locale %}
                            {{ ux_icon('heroicons:check', {class: 'w-4 h-4 ml-auto text-blue-600 dark:text-blue-400'}) }}
                        {% endif %}
                    </a>
                {% endfor %}
            </div>
        </div>
    </div>
{% endif %}
{# Fallback for browsers without JavaScript - only in main navigation mode #}
{% if not (dropdown_style is defined and dropdown_style) %}
<noscript>
    <div class="relative inline-block text-left">
        <select
            onchange="window.location.href=this.value"
            class="bg-gray-900/95 text-white text-sm border-gray-600/50 rounded-2xl px-3 py-2 focus:outline-none focus:ring-2 focus:ring-white/50 backdrop-blur-md"
            aria-label="{{ 'navbar.select-language'|trans }}"
        >
            <option value="">{{ app.request.locale|upper }}</option>
            {% for locale in locales %}
                {% if locale != app.request.locale %}
                    <option value="{{ path(route, params|merge({ _locale: locale })) }}">
                        {% set locale_names = {
                            'en': 'English',
                            'de': 'Deutsch',
                            'fr': 'Français',
                            'es': 'Español',
                            'it': 'Italiano',
                            'pt': 'Português',
                            'nb': 'Norsk',
                            'gsw': 'Alemannisch',
                        } %}
                        {{ locale_names[locale] ?? locale|upper }}
                    </option>
                {% endif %}
            {% endfor %}
        </select>
    </div>
</noscript>

{% endif %}
